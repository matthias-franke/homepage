<?xml version="1.0" encoding="ISO-8859-1"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<?xml-stylesheet type="text/css" href="styl.css" ?>
<html xmlns="http://www.w3.org/1999/xhtml">
 <head>
  <link rel="stylesheet" href="styl.css" type="text/css" />
  <meta http-equiv="content-type" content="text/html; charset=ISO-8859-1" />
  <title>
   org.conetex.thread
  </title>
 </head>
 <body>
  <h1 id="org.conetex.thread" name="org.conetex.thread">
   org.conetex.thread
  </h1>
  <p>
   <b>org.conetex.thread</b> ist ein freies Java-Framework zur Verwaltung von Threads.
   Bereits Version 1 des Frameworks bietet Java-Entwicklern elegante L&ouml;sungen g&auml;ngiger
   Synchronisationsprobleme. So l&auml;&szlig;t sich auf Basis des Frameworks eine einfache Highlevel-Implementierung
   des bekannten <a href="#Philosophenproblem"> Philosophenproblems </a> erstellen.
  </p>
  <p>
   Matthias Franke
  </p>
  <h2 id="Inhalt" name="Inhalt">
   Inhalt
  </h2>
  <ul>
   <li>
    <a href="#org.conetex.thread">
     org.conetex.thread
    </a>
    <ul>
     <li>
      <a href="#Inhalt">
       Inhalt
      </a>
     </li>
     <li>
      <a href="#Download">
       Download
      </a>
     </li>
     <li>
      <a href="#KONZEPTE">
       Konzepte
      </a>
      <ul>
       <li>
        <a href="#SEMAPHOR">
         Semaphor
        </a>
       </li>
       <li>
        <a href="#SYNCHRONIZED MONITOR IN JAVA">
         Synchronized Monitor in Java
        </a>
       </li>
      </ul>
     </li>
     <li>
      <a href="#Sluice">
       Sluice - Implementierung des Semaphor-Konzepts durch Monitore
      </a>
      <ul>
       <li>
        <a href="#ZUGRIFFSERLAUBNIS">
         Zugriffserlaubnis
        </a>
       </li>
      </ul>
     </li>
     <li>
      <a href="#SluiceCluster">
        SluiceCluster, SluiceJoined - Implementierung von Abh&auml;ngigkeiten zwischen Semaphoren
      </a>
      <ul>
       <li>
        <a href="#Philosophenproblem">
         Das Philosophenproblem
        </a>
        <ul>
         <li>
          <a href="#Implementierung Philosophenproblem">
           Implementierung Philosophenproblem
          </a>
         </li>
        </ul>
       </li>
      </ul>
     </li>
     <li>
      <a href="#Implementierung MutualExclusion">
       Implementierung MutualExclusion
      </a>
      <ul>
       <li>
        <a href="#class MutualExclusion">
         class MutualExclusion
        </a>
        <ul>
         <li>
          <a href="#interface Semaphor">
           interface Semaphor
          </a>
         </li>
         <li>
          <a href="#class Sluice">
           class Sluice
          </a>
         </li>
         <li>
          <a href="#class SluiceJoined">
           class SluiceJoined
          </a>
         </li>
         <li>
          <a href="#class SluiceCluster">
           class SluiceCluster
          </a>
         </li>
        </ul>
       </li>
      </ul>
     </li>
    </ul>
   </li>
  </ul>
  <h2 id="Download" name="Download">
   Download
  </h2>
  <p>
   <ul>
    <li>
     <p>
      Framework:
      <a href="v 0.0.2/org.conetex.thread.0.0.2.jar">
       org.conetex.thread.0.0.2.jar
      </a>
     </p>
     <p>
      Um <b>org.conetex.thread</b> in Ihrem Java-Projekt zu nutzen,
      binden Sie die jar-Datei als Library in den
      Build Path ihrer Entwicklungsumgebung ein.
     </p>
     <p>
      Quellcode:
      <a href="v 0.0.2/org.conetex.thread.0.0.2.src.zip">
       org.conetex.thread.0.0.2.src.zip
      </a>
     </p>
     <p>
      Die Beispiel-Implementierung des Philosophenproblems starten Sie
      mit dem Befehl &quot;<b>java -jar org.conetex.thread.0.0.2.jar</b>&quot; auf der Kommandozeile.
     </p>
    </li>
<!--
    <li>
     Code:
     <a href="v 0.0.1/org.conetex.thread.0.0.1 beta src.zip">
      org.conetex.thread.0.0.1 beta src.zip
     </a>
    </li>
-->
   </ul>
  </p>
  <h2 id="KONZEPTE" name="KONZEPTE">
   Konzepte
  </h2>
  <h3 id="SEMAPHOR" name="SEMAPHOR">
   Semaphor
  </h3>
  <p>
   Das Semaphor ist ein Konstrukt zur Kontrolle des Zugriffs auf
   gemeinsame Ressourcen durch mehrere Prozesse. Es wurde urspr&uuml;nglich
   von Dijkstra vorgeschlagen und basiert auf einer ganzzahligen
   Variablen als Flag zur Darstellung der Zugriffserlaubnis und einer
   Warteschlange von Prozessen, denen der Zugriff zun&auml;chst verweigert
   wurde. Der Semaphor kennt zwei Operationen:
  </p>
  <ul>
   <li>
    <h4>
     ENTER
    </h4>
    <p>
     Die Operation "down" (in dieser Implementierung "enter") realisiert die
     Warteoperation beim Betreten eines kritischen Bereichs. Gem&auml;&szlig; des Status
     der Zugriffserlaubnis wird das Betreten des kritischen Bereichs erlaubt oder
     der Prozess unterbrochen und in der Warteschlange abgelegt. Intern wird die
     Variable heruntergez&auml;hlt. Als Reminiszenz an den holl&auml;ndischen Erfinder
     Dijkstra wird diese Operation oft auch "p" f&uuml;r "passeer" genannt.
    </p>
   </li>
   <li>
    <h4>
     LEAVE
    </h4>
    <p>
     Die Operation "up" (in dieser Implementierung "leave") realisiert eine
     Signaloperation beim Verlassen des kritischen Bereichs. Intern wird die
     Variable heraufgez&auml;hlt. Ist die Warteschlange von Prozessen nicht leer, so
     wird einer der wartenden Prozesse aktiviert. Als Name von "up"
     wird oft auch "v" f&uuml;r holl&auml;ndisch "verlaat" gew&auml;hlt.
    </p>
   </li>
  </ul>
  <h3 id="SYNCHRONIZED MONITOR IN JAVA" name="SYNCHRONIZED MONITOR IN JAVA">
   Synchronized Monitor in Java
  </h3>
  <p>
   Ein Monitor ist die Kapselung eines kritischen Bereichs
   (also eines Programmteils, der nur von jeweils einem Prozess zur Zeit
   durchlaufen werden darf) mit Hilfe einer automatisch verwalteten Sperre.
   Diese Sperre wird beim Betreten des Monitors gesetzt und beim Verlassen
   wieder zur&uuml;ckgenommen. Ist sie beim Eintritt in den Monitor bereits von
   einem anderen Prozess gesetzt, so mu&szlig; der aktuelle Prozess warten, bis
   der Konkurrent die Sperre freigegeben und den Monitor verlassen hat.
   Das Monitor-Konzept lie&szlig;e sich unter Verwendung eines Semaphor
   implementieren, dessen Operation "down" beim Betreten des zu gesch&uuml;tzten
   Programmteils aufgerufen wird und dessen Operation "up" beim Verlassen des
   gesch&uuml;tzten Programmteils aufgerufen wird.
  </p>
  <p>
   Die 'synchronized'-Deklaration in Java realisiert das Monitor-Konzept.
   Durch synchronized kann entweder eine komplette Methode oder ein Block
   innerhalb einer Methode gesch&uuml;tzt werden. Der Eintritt in den so
   deklarierten Monitor wird durch das Setzen einer Sperre auf einer
   Objektvariablen erreicht. Bezieht sich synchronized auf eine komplette
   Methode, wird als Sperre der this-Pointer verwendet, andernfalls ist
   eine Objektvariable explizit anzugeben.
  </p>
  <h2 id="Sluice" name="Sluice">
   Sluice -
   <br />
   Implementierung des Semaphor-Konzepts durch Monitore
  </h2>
  <h3 id="ZUGRIFFSERLAUBNIS" name="ZUGRIFFSERLAUBNIS">
   Zugriffserlaubnis
  </h3>
  <p>
   Das Interface Semaphore definiert einen gesch&uuml;tzten Bereich, der nur von
   einem Thread gleichzeitig betreten werden kann. Die Klasse Sluice
   implementiert Semaphore gem&auml;&szlig; des Semaphor-Konzepts. Die Methode enter()
   implementiert das Betreten des kritischen Bereichs analog zur Semaphor-
   Operation 'down'. Die Methode leave() realisiert das Verlassen des kritischen
   Bereichs analog zur Semaphor- Operation 'up'. Sluice verwendet eine
   Variable 'locked' vom Typ 'boolean' als Flag zur Darstellung der
   Zugriffserlaubnis. 'locked' wird innerhalb von enter() auf true gesetzt,
   innerhalb von leave() wird 'locked' auf false gesetzt. Dadurch, dass enter()
   und leave() als synchronized gekennzeichnet sind, ist der Zugriff auf
   'locked' gesch&uuml;tzt - Java-Threads, die auf einen per 'synchronized' gesetzten
   Monitor treffen, warten bis die Sperre aufgehoben wird, also der Konkurrent
   den Monitor verlassen hat.
  </p>
  <p>
   Das Semaphor verf&uuml;gt &uuml;ber eine Warteschlange von Prozessen, denen der Zugriff
   zun&auml;chst verweigert wurde, da der gesch&uuml;tzte Bereich bereits von einem
   Prozess betreten wurde. Die Klasse Sluice verwendet die Java interne
   Warteliste f&uuml;r Threads, die in 'Object' indirekt durch die Benutzung von
   'wait()' zur Verf&uuml;gung steht: Versucht ein Thread B Zurgriff auf den
   gesch&uuml;tzten Bereich zu erhalten, so ruft er enter() auf. Ist der gesch&uuml;tzte
   Bereich bereits im Zugriff eines Threads A, so wird der Thread B durch den
   Aufruf von wait() unterbrochen. Dadurch gelangt Thread B in die von Java
   pro Object verwaltete Liste wartender Threads. Verl&auml;&szlig;t nun Thread A durch den
   Aufruf der Methode 'leave' den gesch&uuml;tzten Bereich, so wird mit 'notify()'
   ein wartender Thread aus der Warteliste reaktiviert. Der reaktivierte
   Thread B setzt also die Verarbeitung in enter() fort und erh&auml;lt dadurch
   den Zugriff auf den gesch&uuml;tzten Bereich, auf den er gewartet hatte.
  </p>
  <h2 id="SluiceCluster" name="SluiceCluster">
    SluiceCluster, SluiceJoined -
   <br />
    Implementierung von Abh&auml;ngigkeiten zwischen Semaphoren
  </h2>
  <p>
   Die Kontrolle des Zugriffs auf gemeinsame genutzte Ressourcen ist komplexer,
   wenn zwischen den Ressourcen Abh&auml;ngigkeiten bestehen. Die Schwierigkeit
   der Synchronisation abh&auml;ngiger Zugriffe wird oft anhand des Philosophenproblems verdeutlicht:
  </p>
  <h3 id="Philosophenproblem" name="Philosophenproblem">
   Das Philosophenproblem
  </h3>
  <p>
   F&uuml;nf Philosophen sitzen an einem runden Tisch.
  </p>
  <p>
   Zwischen zwei Philosophen liegt jeweils eine Gabel auf dem Tisch. Der
   Lebenszyklus eines jeden Philosophen besteht aus den Operationen "Essen"
   und "Schlafen" und l&auml;uft jeweils in einem eigenen Prozess / Thread ab. Die
   L&auml;nge der Essensphase wird durch Zufall bestimmt. Zum Essen ben&ouml;tigt der
   Philosoph die linke Gabel, die zwischen ihm und seinem linken Nachbarn
   liegt, und die rechte Gabel, die zwischen ihm und seinem rechten Nachbarn
   liegt. Der Philosoph kann auf die Gabel nur dann zugreifen, wenn diese
   gerade nicht von seinem Nachbarn verwendet wird.
  </p>
  <pre>
  ....................................................................
  : S T A R T                                                        :
  :                                                                  :
  : philosopher E \\\\\\        |||         ||||||  philosopher A    :
  : is SLEEPING  (  - - )       \ /        ( _ _  ) is SLEEPING      :
  :               |    |         |          |    |                   :
  :                \_=/          |           \-_/                    :
  :                              |                                   :
  :                           fork EA                                :
  :                           is NOT USED                            :
  :            |||                                  |||              :
  :            \ /                                  \ /              :
  :     fork DE |                __                  | fork AB       :
  : is NOT USED |             __/ (_                 | is NOT USED   :
  :             |            /_     \/|              |               :
  :                         (    ((   (                              :
  :                          \o_____/\|                              :
  :                                                                  :
  :       /)))))                                      """""\         :
  :      (  - - )                                    ( - -  )        :
  :       |    |                                      |    |         :
  :        \_-/                                        \-_/          :
  :                                                                  :
  : philosopher D     |||                  |||         philosopher B :
  : is SLEEPING       \ /                  \ /         is SLEEPING   :
  :                    |                    |                        :
  :                    |                    |                        :
  :            fork CD |                    | fork BC                :
  :        is NOT USED        //////          is NOT USED            :
  :                          ( _ _  )                                :
  :                           |    |                                 :
  :             philosopher C  \-_/                                  :
  :             is SLEEPING                                          :
  :..................................................................:
  </pre>
  <p>
   Durch Verwendung von f&uuml;nf einfachen Semaphoren (Sluice), die jeweils
   den Zugriff auf eine Gabel synchronisiert, ist sichergestellt, dass eine
   Gabel zur gleichen Zeit nur von einem Philosophen verwendet wird. Die Klasse
   Gabel wird dazu von Sluice abgeleitet und implementiert damit das
   Interface Semaphore.
  </p>
  <pre>
  ....................................................................
  : P H I L O S O P H E R S   L I V E C Y C L E   A                  :
  :                                                                  :
  : philosopher E \\\\\\  |||               ||||||  philosopher A    :
  : is EATING    (  . . ) \ /              ( . .  ) is WAITING       :
  :               |    |   | fork EA        |    |                   :
  :           |||  \_O/    | is USED         \~_/                    :
  :           \ /    ___   | by E                                    :
  :    fork DE |    /:  \/|                                          :
  :    is USED |    \___/\|                                          :
  :    by E    |                                                     :
  :                                                                  :
  :                              __                                  :
  :                           __/ (_                                 :
  :                          /_     \/|           ||| fork AB        :
  :                         (    ((   (           \ / is USED        :
  :                          \o_____/\|            |  by B           :
  :                                           ___  |                 :
  :       /)))))                           |\/  :\ |  """""\         :
  :      (  . . )  |||                     |/\___/   ( . .  )        :
  :       |    |   \ /                                |    |         :
  :        \_~/     | fork CD                    |||   \O_/          :
  :                 | is USED                    \ /                 :
  : philosopher D   | by D                fork BC |    philosopher B :
  : is WAITING                            is USED |    is EATING     :
  :                                       by B    |                  :
  :                                                                  :
  :                                                                  :
  :                           //////                                 :
  :                          ( _ _  )                                :
  :                           |    |                                 :
  :             philosopher C  \-_/                                  :
  :             is WAITING                                           :
  :..................................................................:
  </pre>
  <p>
   Aber sobald der Philosoph eine seiner Gabeln festh&auml;lt, wartet er darauf,
   dass er auch Zugriff auf die zweite Gabel erh&auml;lt, die von seinem Nachbar
   festgehalten wird. Fr&uuml;her oder sp&auml;ter befinden sich alle Philosophen in
   diesem Wartezustand: Jeder der f&uuml;nf Philosophen h&auml;lt eine der f&uuml;nf Gabeln
   fest, dadurch erh&auml;lt keiner der wartenden Philosophen den Zugriff auf eine
   zweite Gabel - die Philosophen verhungern.
  </p>
  <pre>
  ....................................................................
  : P H I L O S O P H E R S   L I V E C Y C L E   B                  :
  :                                                                  :
  : philosopher E \\\\\\         |||        ||||||  philosopher A    :
  : is WAITING   (  . . )        \ /       ( _ _  ) is SLEEPING      :
  :               |    |          |         |    |                   :
  :           |||  \_~/           |          \-_/                    :
  :           \ /                 |                                  :
  :    fork DE |              fork EA                                :
  :    is USED |              is NOT USED                            :
  :    by E    |                                    |||              :
  :                                                 \ /              :
  :                              __                  | fork AB       :
  :                           __/ (_                 | is NOT USED   :
  :                          /_     \/|              |               :
  :                         (    ((   (                              :
  :                          \o_____/\|                              :
  :                                                                  :
  :       /)))))                                      """""\         :
  :      (  . . )  |||                               ( - -  )        :
  :       |    |   \ /                                |    |         :
  :        \_~/     | fork CD                          \-_/          :
  :                 | is USED                                        :
  : philosopher D   | by D                 |||         philosopher B :
  : is WAITING                             \ /         is SLEEPING   :
  :                                         |                        :
  :                                         |                        :
  :                                         | fork BC                :
  :                           //////          is NOT USED            :
  :                          ( . .  )                                :
  :                           |    |                                 :
  :             philosopher C  \~_/                                  :
  :             is WAITING                                           :
  :..................................................................:
  ....................................................................
  : D E A D L O C K                                                  :
  :                                                                  :
  : philosopher E \\\\\\              |||   ||||||  philosopher A    :
  : is WAITING   (  . . )             \ /  ( . .  ) is WAITING       :
  :               |    |       fork EA |    |    |                   :
  :           |||  \_~/        is USED |     \~_/                    :
  :           \ /              by A    |                             :
  :    fork DE |                                                     :
  :    is USED |                                                     :
  :    by E    |                                                     :
  :                                                                  :
  :                              __                                  :
  :                           __/ (_                                 :
  :                          /_     \/|           ||| fork AB        :
  :                         (    ((   (           \ / is USED        :
  :                          \o_____/\|            |  by B           :
  :                                                |                 :
  :       /)))))                                   |  """""\         :
  :      (  . . )  |||                               ( . .  )        :
  :       |    |   \ /                                |    |         :
  :        \_~/     | fork CD                          \~_/          :
  :                 | is USED                                        :
  : philosopher D   | by D                             philosopher B :
  : is WAITING                                         is WAETING    :
  :                                                                  :
  :                                  |||                             :
  :                                  \ /                             :
  :                           //////  | fork BC                      :
  :                          ( . .  ) | is USED                      :
  :                           |    |  | by C                         :
  :             philosopher C  \~_/                                  :
  :             is WAITING                                           :
  :..................................................................:
  </pre>
  <p>
   Das gegenseitige Blockieren k&ouml;nnen die Philosophen dadurch vermeiden, dass
   sie ihre Gabel wieder loslassen und freigeben, wenn sie keinen Zugriff auf
   die zweite Gabel erhalten. Es gibt zwei M&ouml;glichkeiten bei der Implementierung
   Deadlocks auszuschlie&szlig;en:
  </p>
  <ul>
   <li>
    <p>
     Der Zugriff auf die beiden Gabeln des Philosophen wird in einer einzelnen
     Operation enter(Semaphore[]) zusammengefasst. Der Philosoph erh&auml;lt damit
     Zugriff auf beide Gabeln oder keine der Gabeln. Das Festhalten nur einer der
     Gabeln ist nicht mehr m&ouml;glich.
    </p>
    <p>
     Da die Klasse Gabel von Sluice abgeleitet ist, k&ouml;nnen die Objekte
     "rechte Gabel" und "linke Gabel" in einem Array einfach an die statische
     Methode enter(Semaphore[]) &uuml;bergeben werden. Diese Methode versucht der Reihe
     nach Zugriff auf jedes der Semaphore-Objekt im Array zu erhalten. Ist eines
     der Objecte im Array durch einen anderen Thread bereits gesperrt worden, gibt
     enter(Semaphore[]) diejenigen Objecte, auf die es Zugriff erhalten konnte,
     wieder frei. Daraufhin wartet enter(Semaphore[]) bis die von dem anderen
     Thread gesperrte Semaphore wieder frei wird, und versucht erneut der Reihe
     nach den Zugriff auf alle Semaphore-Objekte im Array zu erhalten.
     F&uuml;r das Philosophenproblem hei&szlig;t das, dass der Philosoph die Gabel, auf die
     er bereits Zugriff hat, zur&uuml;cklegt, wenn seine zweite Gabel von seinem
     Nachbarn verwendet wird. Er wartet solange, bis er nach Ende der Essensphase
     des Nachbarn auf die zweite Gabel zugreifen kann, und versucht dann erneut,
     auch auf beide Gabeln zuzugreifen.
    </p>
   </li>
   <li>
    <p>
     Der Zugriff auf die beiden Gabeln des Philosophen wird als einzelner
     Zugriff auf ein gemeinsames Objekt (SluiceJoined) implementiert, das die
     beiden Gablen verwaltet. F&uuml;r jeden Philosophen wird ein SluiceJoined-
     Object eingef&uuml;hrt. Die beiden Gabeln eines Philosophen werden bei ihrem
     gemeinsamen SluiceJoined-Object registriert. Dazu wird die Gabel-Klasse
     von SluiceCluster abgeleitet, um das Gabel-Object an die Methode
     addDependingRessource(SluiceCluster) des SluiceJoined-Objects zu
     &uuml;bergeben. Jede Gabel ist damit erstens beim SluiceJoined-Object des
     Philosophen registriert, der sie mit der linken Hand aufnimmt, und zweitens
     bei dem SluiceJoined-Object von dessen Nachbarn registriert, der die
     Gabel mit der rechten Hand aufnimmt.
    </p>
    <p>
     Wird auf eine Gabel zugegriffen, so informiert die Methode enter() alle
     SluiceJoined-Objecte, bei denen die Gabel registriert ist. Dadurch kann
     ein Z&auml;hler im SluiceJoined-Object Auskunft dar&uuml;ber geben, dass sich eine
     der registrierten SluiceCluster-Objecte also Gabel-Objecte im Zugriff
     eines anderen Prozesses befindet. Versucht also ein Philosoph seine Gabeln
     aufzunehmen, indem er die Methode enter() des SluiceJoined-Objects
     aufruft, wird der Philosoph in den Wartezustand versetzt, ohne dass es n&ouml;tig
     ist, den Zugriff auf die Gabeln der Reihe nach auszuprobieren. Die
     Information, dass eine der ben&ouml;tigten Gabeln durch einen anderen Prozess
     blockiert ist, liegt ja bereits vor.
    </p>
    <p>
     Wird die Gabel frei, so informiert die Methode leave() alle SluiceJoined-
     Objecte, bei denen die Gabel registriert ist. Der Z&auml;hler im SluiceJoined-
     Object wird heruntergesetzt. Steht der Z&auml;hler damit wieder auf null, so
     bedeutet dies, dass keine der beim SluiceJoined-Object registrierten
     Gabeln in Benutzung ist. Der Philosoph, den das SluiceJoined-Object zuvor
     in den Wartezustand versetzte, wird in diesem Fall wieder aufgeweckt, denn
     nun lohnt sein Versuch, auf die frei gewordenen Gabeln zugreifen. Der Zugriff
     auf die einzelnen Gabel, der - wie oben beschrieben - als Aufruf der Methode
     enter() eines SluiceCluster-Objects implementiert ist, inkrementiert
     nun wieder die Z&auml;hler der SluiceCluster-Objecte, bei denen die Gabel
     registriert ist. SluiceCluster kann auf diese Weise zentral den Zugriff
     auf eine Menge von Ressourcen (SluiceJoined) regeln, ohne dass die Zugriffe auf die Elemente
     der Menge unn&ouml;tig oft einzeln durchprobiert werden m&uuml;ssen. Daher lohnt eine
     Implementierung mit SluiceJoined vorallem dann, wenn es gilt, eine
     gr&ouml;&szlig;ere Menge von Ressourcen zu verwalten.
    </p>
   </li>
  </ul>
  <h4 id="Implementierung Philosophenproblem" name="Implementierung Philosophenproblem">
   Implementierung Philosophenproblem
  </h4>
  <pre>
import java.io.IOException;
import org.conetex.thread.MutualExclusion;
import org.conetex.thread.MutualExclusion.SluiceCluster;

public class Example{

  final static String STATUS_WAITING =  &quot;waiting &quot;;
  final static String STATUS_EATING =   &quot;eating  &quot;;
  final static String STATUS_SLEEPING = &quot;sleeping&quot;;
  final static int STANDARD_MEASURE = 500;

  private static class Fork extends MutualExclusion.SluiceJoined{

    private String user;

    public String getUser(){
      return user;
    }

    public void setUser(String user) throws Exception{
      if(user != null &amp;&amp; this.user != null){
        throw new Exception(&quot;Thread &quot; + user + &quot;(&quot; + Thread.currentThread() + &quot;) is entering &quot; + this + &quot; owned by &quot; + this.user + &quot;!&quot;);
      }
      if(user == null &amp;&amp; this.user == null){
        throw new Exception(&quot;Thread &quot; + Thread.currentThread() + &quot; is leaving &quot; + this + &quot;, but is not its owner!&quot;);
      }
      this.user = user;
    }

  }

  private static class Philosopher extends ControlledProcess{

    private SluiceCluster forksCluster;

    private Fork[] forks;

    private String name;

    private String status;

    private int eatTime;

    private long totalEatTime;

    private Philosopher(Fork[] forks, String name, int sleepTime, int eatTime){
      super(sleepTime);
      this.forksCluster = new SluiceCluster(forks);
      this.forks = new Fork[forks.length];
      System.arraycopy(forks, 0, this.forks, 0, forks.length);
      this.totalEatTime = 0;
      this.eatTime = eatTime;
      this.status = Example.STATUS_SLEEPING;
      this.name = name;
    }

    public static Philosopher create(Fork[] forks, String name, int sleepTime, int eatTime){
      if(forks == null || forks.length == 0 || sleepTime &lt; 1 || eatTime &lt; 1){
        return null;
      }
      for(int i = 0; i &lt; forks.length; i++){
        if(forks[i] == null){
          return null;
        }
      }
      return new Philosopher(forks, name, sleepTime, eatTime);
    }

    public void run(){
      int i = 0;
      // lifecycle
      while(this.isLiving()){
        // waiting
        this.status = Example.STATUS_WAITING;
        this.forksCluster.enter();
        // eating
        this.status = Example.STATUS_EATING;
        while(i &lt; this.forks.length){
          try{
            this.forks[i].setUser(this.name);
          }
          catch(Exception e){
            System.out.println(e.getMessage());
            System.exit(1);
          }
          i++;
        }
        i = 0;
        this.eat();
        while(i &lt; this.forks.length){
          try{
            this.forks[i].setUser(null);
          }
          catch(Exception e){
            System.out.println(e.getMessage());
            System.exit(1);
          }
          i++;
        }
        i = 0;
        this.forksCluster.leave();
        // sleeping
        this.status = Example.STATUS_SLEEPING;
        this.sleep();
      }
    }

    private void eat(){
      long eatTime = (long)(this.eatTime * Math.random() + 1);
      Example.threadSleep( eatTime );
      this.totalEatTime = this.totalEatTime + eatTime;
    }

    private void sleep(){
      Example.threadSleep( (long)(this.getSleepTime() * Math.random() + 1) );
    }

    public String getStatus(){
      return status;
    }

    public long getTotalEatTime(){
      return totalEatTime;
    }

    public String toString(){
      return this.name;
    }

  }

  private static void threadSleep(long sleepTime){
    try{
      Thread.sleep(sleepTime);
    }
    catch(InterruptedException e){
      e.printStackTrace();
    }
  }

  private abstract static class ControlledProcess implements Runnable{

    private boolean living;

    private int sleepTime;

    protected ControlledProcess(int time){
      this.sleepTime = time;
      this.living = true;
    }

    public int getSleepTime(){
      return sleepTime;
    }

    public void setSleepTime(int sleepTime){
      if(sleepTime &gt; 0){
        this.sleepTime = sleepTime;
      }
    }

    public boolean isLiving(){
      return this.living;
    }

    public void setLiving(boolean alive){
      this.living = alive;
    }

  }

}
  </pre>
  <h2 id="Implementierung MutualExclusion" name="Implementierung MutualExclusion">
   Implementierung MutualExclusion
  </h2>
  <pre>
package org.conetex.thread;

import java.util.HashSet;
import java.util.Iterator;

</pre>
  <h3 id="class MutualExclusion" name="class MutualExclusion">// class MutualExclusion</h3>
<pre>
/* Version 0.0.1 */
public class MutualExclusion{ // Semaphor

  public static void enter(Semaphor[] ressourceGroup){
    if(ressourceGroup == null || ressourceGroup.length == 0){
      return;
    }
    int master = 0;
    // setze die Master-Sperre
    ressourceGroup[master].enter();
    int i = ressourceGroup.length;
    // setze die Extra-Sperren
    loop:
    do{
      // setze Extra-Sperren hinter der Master-Sperre
      while(--i &gt; master){
        // versuche, eine Extra-Sperre zu setzen
        if(ressourceGroup[i] != null &amp;&amp; !ressourceGroup[i].tryEnter()){
          ressourceGroup[master].leave();
          master = i;
          // die Extra-Sperre ist nicht setzbar: entferne sämtliche Extra-Sperren und die Master-Sperre
          while(++i &lt; ressourceGroup.length){
            if(ressourceGroup[i] != null){
              ressourceGroup[i].leave();
            }
          }
          // setze die Master-Sperre erneut
          ressourceGroup[master].enter();
        }
      }
      // Alle Extra-Sperren hinter der Master-Sperre sind gesetzt!
      i = master;
      // setze Extra-Sperre vor der Master-Sperre
      while(--i &gt;= 0){
        // versuche, eine Extra-Sperre zu setzen
        if(ressourceGroup[i] != null &amp;&amp; !ressourceGroup[i].tryEnter()){
          ressourceGroup[master].leave();
          master = i;
          // die Extra-Sperre ist nicht setzbar: entferne sämtliche Extra-Sperren und die Master-Sperre
          while(++i &lt; ressourceGroup.length){
            if(ressourceGroup[i] != null){
              ressourceGroup[i].leave();
            }
          }
          // setze die Master-Sperre erneut
          ressourceGroup[master].enter();
          // setze die Extra-Sperren erneut. Beginne dazu von vorn!
          continue loop;
        }
      }
      // Alle Extra-Sperren vor der Master-Sperre sind gesetzt!
      break loop;
    }while(true);
  }

  public static boolean tryEnter(Semaphor[] ressourceGroup){
    // Siehe Kommentar zu Sluice.enter()!
    if(ressourceGroup == null || ressourceGroup.length == 0){
      return true;
    }
    int i;
    i = ressourceGroup.length;
    while(i-- &gt; 0){
      if(ressourceGroup[i] != null &amp;&amp; !ressourceGroup[i].tryEnter()){
        while(++i &lt; ressourceGroup.length){
          ressourceGroup[i].leave();
        }
        return false;
      }
    }
    return true;
  }

  public static void leave(Semaphor[] ressourceGroup){
    // entferne sämtliche Sperren
    if(ressourceGroup != null){
      for(int i = 0; i &lt; ressourceGroup.length; i++){
        if(ressourceGroup[i] != null){
          ressourceGroup[i].leave();
        }
      }
    }
  }

</pre>
  <h4 id="interface Semaphor" name="interface Semaphor">// interface Semaphor</h4>
<pre>
  public static interface Semaphor{ // Ressource

    public boolean isLocked();

    public boolean tryEnter();

    public void enter();

    public void leave();

  }

</pre>
  <h4 id="class Sluice" name="class Sluice">// class Sluice</h4>
<pre>
  /*
  the following example shows the prozessing of two Threads entering a sluice:
  ................... ................... ...................
  : A               : : B               : : C               :
  :                 : :                 : :                 :
  :   ___________   : :   ___________   : :   ___________   :
  :  ||---------||  : :  ||---------||  : :  ||---------||  :
  :  ||         ||  : :  ||         ||  : :  ||    _    ||  :
  :  ||         ||  : :  ||         ||  : :  ||   / \   ||  :
  :  ||         ||  : :  ||         ||  : :  ||   |T|   ||  :
  :  ||         ||  : :  ||         ||  : :  ||   |H|   ||  :
  :  ||         ||  : :  ||         ||  : :  ||   |R|   ||  :
  :  ||         ||  : :  ||         ||  : :  ||   |E|   ||  :
  :  ||         ||  : :  ||         ||  : :  ||   |A|   ||  :
  :  ||         ||  : :  ||         ||  : :  ||   |D|   ||  :
  :  ||         ||  : :  ||    _    ||  : :  ||   | |   ||  :
  :  ||         ||  : :  ||   / \   ||  : :  ||   |1|   ||  :
  :  ||         ||  : :  ||   |T|   ||  : :  ||   |_|   ||  :
  :  ||_________||  : :  ||   |H|   ||  : :  ||_________||  :
  :   -----------   : :  \\   |R|   //  : :   -----------   :
  :                 : :   \\  |E|  //   : :        _        :
  :                 : :    \\ |A| //    : :       / \       :
  :      _   _      : :       |D|  _    : :       |T|       :
  :     / \ / \     : :       | | / \   : :       |H|       :
  :     |T| |T|     : :       |1| |T|   : :       |R|       :
  :     |H| |H|     : :       |_| |H|   : :       |E|       :
  :     |R| |R|     : :           |R|   : :       |A|       :
  :     |E| |E|     : :           |E|   : :       |D|       :
  :     |A| |A|     : :           |A|   : :       | |       :
  :     |D| |D|     : :           |D|   : :       |2|       :
  :     | | | |     : :           | |   : :       |_|       :
  :     |1| |2|     : :           |2|   : :                 :
  :     |_| |_|     : :           |_|   : :                 :
  :.................: :.................: :.................:
  ................... ................... ...................
  : D               : : E               : : F      _        :
  :                 : :                 : :       / \       :
  :                 : :        _        : :       |T|       :
  :                 : :       / \       : :       |H|       :
  :                 : :       |T|       : :       |R|       :
  :                 : :       |H|       : :       |E|       :
  :        _        : :       |R|       : :       |A|       :
  :       / \       : :       |E|       : :       |D|       :
  :       |T|       : :       |A|       : :       | |       :
  :       |H|       : :       |D|       : :       |1|       :
  :       |R|       : :       | |       : :       |_|       :
  :    // |E| \\    : :       |1|       : :                 :
  :   //  |A|  \\   : :       |_|       : :                 :
  :  //   |D|   \\  : :   ___________   : :   ___________   :
  :  ||   | |   ||  : :  ||---------||  : :  ||---------||  :
  :  ||   |1|   ||  : :  ||         ||  : :  ||         ||  :
  :  ||   |_|   ||  : :  ||         ||  : :  ||         ||  :
  :  ||         ||  : :  ||         ||  : :  ||         ||  :
  :  ||         ||  : :  ||         ||  : :  ||         ||  :
  :  ||         ||  : :  ||         ||  : :  ||         ||  :
  :  ||         ||  : :  ||         ||  : :  ||         ||  :
  :  ||         ||  : :  ||         ||  : :  ||         ||  :
  :  ||         ||  : :  ||         ||  : :  ||         ||  :
  :  ||         ||  : :  ||         ||  : :  ||         ||  :
  :  ||         ||  : :  ||         ||  : :  ||    _    ||  :
  :  ||         ||  : :  ||         ||  : :  ||   / \   ||  :
  :  ||_________||  : :  ||_________||  : :  ||   |T|   ||  :
  :   -----------   : :   -----------   : :  \\   |H|   //  :
  :        _        : :        _        : :   \\  |R|  //   :
  :       / \       : :       / \       : :    \\ |E| //    :
  :       |T|       : :       |T|       : :       |A|       :
  :       |H|       : :       |H|       : :       |D|       :
  :       |R|       : :       |R|       : :       | |       :
  :       |E|       : :       |E|       : :       |2|       :
  :       |A|       : :       |A|       : :       |_|       :
  :       |D|       : :       |D|       : :                 :
  :       | |       : :       | |       : :                 :
  :       |2|       : :       |2|       : :                 :
  :       |_|       : :       |_|       : :                 :
  :                 : :                 : :                 :
  :                 : :                 : :                 :
  :.................: :.................: :.................:
  ................... ................... ...................
  : G      _        : : H  _            : : I    _   _      :
  :       / \       : :   / \           : :     / \ / \     :
  :       |T|       : :   |T|           : :     |T| |T|     :
  :       |H|       : :   |H|           : :     |H| |H|     :
  :       |R|       : :   |R|           : :     |R| |R|     :
  :       |E|       : :   |E|           : :     |E| |E|     :
  :       |A|       : :   |A|  _        : :     |A| |A|     :
  :       |D|       : :   |D| / \       : :     |D| |D|     :
  :       | |       : :   | | |T|       : :     | | | |     :
  :       |1|       : :   |1| |H|       : :     |1| |2|     :
  :       |_|       : :   |_| |R|       : :     |_| |_|     :
  :                 : :    // |E| \\    : :                 :
  :                 : :   //  |A|  \\   : :                 :
  :   ___________   : :  //   |D|   \\  : :   ___________   :
  :  ||---------||  : :  ||   | |   ||  : :  ||---------||  :
  :  ||    _    ||  : :  ||   |2|   ||  : :  ||         ||  :
  :  ||   / \   ||  : :  ||   |_|   ||  : :  ||         ||  :
  :  ||   |T|   ||  : :  ||         ||  : :  ||         ||  :
  :  ||   |H|   ||  : :  ||         ||  : :  ||         ||  :
  :  ||   |R|   ||  : :  ||         ||  : :  ||         ||  :
  :  ||   |E|   ||  : :  ||         ||  : :  ||         ||  :
  :  ||   |A|   ||  : :  ||         ||  : :  ||         ||  :
  :  ||   |D|   ||  : :  ||         ||  : :  ||         ||  :
  :  ||   | |   ||  : :  ||         ||  : :  ||         ||  :
  :  ||   |2|   ||  : :  ||         ||  : :  ||         ||  :
  :  ||   |_|   ||  : :  ||         ||  : :  ||         ||  :
  :  ||_________||  : :  ||_________||  : :  ||_________||  :
  :   -----------   : :   -----------   : :   -----------   :
  :                 : :                 : :                 :
  :.................: :.................: :.................:
  */
  public static class Sluice implements Semaphor{ // RessourceSingle

    /*
     * Flag zur Darstellung der Zugriffserlaubnis.
     * Wenn 'locked == true' ist der Zugriff verboten.
     * Wenn 'locked == false' ist der Zugriff erlaubt.
     */
    private boolean locked;

    public Sluice(){
      this.locked = false;
    }

    public final synchronized boolean tryEnter(){
      if(this.locked){
        return false;
      }
      this.locked = true;
      return true;
    }

    /*
     *   Der aktuell aufrufende Thread betritt hier den durch den Semaphor
     *   geschützten Bereich.
     */
    public final synchronized void enter(){
      ////System.out.println(&quot;enter   &quot;);
      while(this.locked){
        //// 'locked == true' zeigt an, dass die Semaphor-Sperre bereits gesetzt
        //// wurde. Der aktuell aufrufende Thread wartet daher und verlässt
        //// nicht diese Methode, um die Verarbeitung fortzusetzen. Erst wenn der
        //// Thread, der die Semaphor-Sperre setzte, den geschützten Bereich
        //// mit dem Aufruf von 'leave()' verlässt, wird einer der wartenden
        //// Threads wieder aktiviert.
        // Im Detail:
        // Der aktuell aufrufende Thread wird hier durch den Aufruf von wait(),
        // in die Warteliste des Semaphor-Objects aufgenommen. Dadurch wird er
        // unterbrochen und im Scheduler als wartend markiert. Erst der Aufruf
        // von 'notify()' in 'leave()' entfernt einen beliebigen Prozess aus der
        // Warteliste des Semaphor-Objekts und führt ihn normalem Scheduling zu.
        ////System.out.println(&quot;Boom &quot; + this.toString());
        try{
          this.wait();
        }
        catch(InterruptedException e){
          /** @todo wie ist diese Exception hier zu behandeln? */
        }
      }
      ////////////////////////////////////////////////////////////////////////////
      // Der folgende Abschnitt kann unter zweierlei
      // Umständen betreten werden:
      // A. Der vorstehende Block wurde durch den aktuellen Thread betreten,
      //    da 'locked == true'. Wegen des Aufrufs von 'wait()' wartete dieser
      //    Thread zunächst, ist nun aber durch den Aufruf von 'notify()' wieder
      //    aktiviert worden, so dass er obigen Block verließ und den folgenden
      //    Abschnitt betritt. Kann obiger Block verlassen werden, wenn
      //    'locked == true' (dies ist der Fall bei einem 'if'-Block, der ja
      //    'locked' nur beim Betreten, nicht aber beim Verlassen ausgewertet
      //    wird), so könnte betreffender Thread den geschützten Bereich
      //    betreten, obwohl dieser durch 'locked' noch immer als gesperrt
      //    gekennzeichnet ist. Dies läßt sich durch die Verwendung eines
      //    'while'-Blocks statt eines 'if'-Blocks einfach verhindern.
      //    Im Detail:
      //    Wird ein 'if'-Block verwendet, so kann ein Thread, der im Wettbewerb
      //    um das Betreten der 'synchronized'-Blöcke zunächst gegen den
      //    aufgeweckten Thread gewonnen hatte und somit den folgenden Abschnitt
      //    betritt, 'locked' auf 'true' setzen. Verläßt dieser Gewinner-Thread
      //    daraufhin den 'synchronized'-Block, um Bearbeitungen nach 'enter()'
      //    durchzuführen, so erhält nun der geweckte Thread den Monitor 'this'
      //    und führt die Bearbeitung von 'enter()' fort, obwohl der Gewinner-
      //    Thread die zu schütztende Sluice noch nicht durch den Aufruf von
      //    'leave()' freigegeben hatte.
      // B. Der vorstehende Block wurde nicht betreten, da 'locked == false'.
      //    'locked == false' zeigt an, dass die Semaphor-Sperre noch nicht
      //    gesetzt wurde. Der aktuell aufrufende Thread wartet daher nicht und
      //    verläßt diese Methode, um die Verarbeitung fortzusetzen.
      ////////////////////////////////////////////////////////////////////////////
      // Gilt nun, dass
      // 1. nur ein Thread den folgenden Abschnitt betritt,
      // 2. die Semaphor-Sperre legal aufghoben ist, also 'locked' legal auf
      //    'false' gesetzt wurde,
      // so sichert die folgende Anweisung die Konsistenz der Semaphor-Sperre:
      //// Um Threads warten zu lassen, die im Folgendem diese Methode betreten
      //// bevor der aktuelle aufrufende Thread den durch den Semaphor den
      //// geschützten Bereich mit dem Aufruf von 'leave()' verläßt, wird die
      //// Semaphor-Sperre nun gesetzt. Dazu wird 'locked' auf 'true' gesetzt.
      this.locked = true;
    }

    /*
     *   Der aktuell aufrufende Thread verläßt hier
     *   den durch den Semaphor geschützten Bereich.
     */
    public final synchronized void leave(){
      //// Um Threads im Folgendem zu erlauben, die
      //// Verarbeitung nach dem Betreten von 'enter()'
      //// fortzusetzen, wird die Semaphor-Sperre
      //// entfernt, das heißt 'locked' wird auf
      //// 'false' gesetzt.
      this.locked = false;
      //// Da die Sperre nun entfernt ist, kann jetzt
      //// eine eventuell wartender Thread aktiviert werden.
      // Da diese Methode als 'synchronized' deklariert ist,
      // bleibt sichergestellt, dass kein weiterer Thread
      // Code dieses Semaphor-Objects ausführen kann und
      // so wegen der oben gerade aufgehobenen Sperre
      // gleichzeitig mit dem eventuell gleich per 'notify()'
      // wieder aktivierten Thread den zu schützenden
      // Bereich betritt.
      this.notify();
    }

    public final synchronized boolean isLocked(){
      return this.locked;
    }

  }

</pre>
  <h4 id="class SluiceJoined" name="class SluiceJoined">// class SluiceJoined</h4>
<pre>
  /*
  Deadlocks are caused by denied access on synchronized methods:

          Thread_1 ||      Thread_2
              |    ||          |
         enter|    ||          |leave
              |    ||          |
             _V_   ||         _V_
   Sluice-  |   |  ||        |   |Sluice-
   Joined_1 |___|  ||        |___|Joined_2
             / \   ||         / \
            /   \  ||&lt;remove /   \
           /  try\ || \Lock /     \
          /  Enter&gt;||  \   /leave  \
         V         ||  _\_V         V
     ...           || |   |           ...
                   || |___|SluiceCluster
                   ||
     Monitor       || Monitor
     SluiceCluster || SluiceCluster

  To prevent for deadlocks the synchronization-monitor on SluiceJoined in
  methode removeLock has to been left before calling synchronized methods
  on SluiceCluster.
  */
  public static class SluiceJoined implements Semaphor{ // RessourceDepending

    private final HashSet managingSluiceClusterHash;

    private final Sluice delegate;

    public SluiceJoined(){
      super();
      this.managingSluiceClusterHash = new HashSet();
      this.delegate = new Sluice();
    }

    public synchronized final boolean isLocked(){
      return this.delegate.isLocked();
    }

    public final boolean tryEnter(){
      if(!this.delegate.tryEnter()){
        return false;
      }
      Iterator i = this.managingSluiceClusterHash.iterator();
      SluiceCluster ressource;
      while(i.hasNext()){
        ressource = (SluiceCluster)i.next();
        ressource.addLock();
      }
      return true;
    }

    public final void enter(){
      this.delegate.enter();
      Iterator i = this.managingSluiceClusterHash.iterator();
      while(i.hasNext()){
        ((SluiceCluster)i.next()).addLock();
      }
    }

    public final void leave(){
      synchronized(this){
        if(this.delegate.isLocked()){
          this.delegate.leave();
        }
        else{
          return;
        }
      }
      Iterator i = this.managingSluiceClusterHash.iterator();
      while(i.hasNext()){
        ((SluiceCluster)i.next()).removeLock();
      }
    }

    private synchronized final void addManagingSluiceCluster(SluiceCluster manager){
      if(!this.managingSluiceClusterHash.contains(manager)){
        this.managingSluiceClusterHash.add(manager);
      }
    }

    private synchronized final void removeManagingSluiceCluster(SluiceCluster manager){
      this.managingSluiceClusterHash.remove(manager);
    }

  }
</pre>
  <h4 id="class SluiceCluster" name="class SluiceCluster">// class SluiceCluster</h4>
<pre>
  /*
  The Mutual Exclusion of Access to more than one depending Sluices is managed by an Object of class SluiceCluster.
  the following example shows the prozessing of three Threads entering two joined Sluices:
  .............................. .............................. ..............................
  : A    Status: not locked    : : B    Status: locked        : : C                          :
  :                            : :                            : :                            :
  :       //          \\       : :                            : :                            :
  :      //            \\      : :                            : :                            :
  :     //              \\     : :                            : :                            :
  :    //                \\    : :                            : :                            :
  :   //                  \\   : :   ______________________   : :   ______________________   :
  :  |/                    \|  : :  ||--------------------||  : :  ||--------------------||  :
  :  ||                    ||  : :  ||                    ||  : :  ||                    ||  :
  :  ||   SluiceCluster    ||  : :  ||                    ||  : :  ||               _    ||  :
  :  ||                    ||  : :  ||                    ||  : :  ||              / \   ||  :
  :  ||                    ||  : :  ||                    ||  : :  ||              |T|   ||  :
  :  ||//     \\  //     \\||  : :  ||                    ||  : :  ||//     \\  // |H| \\||  :
  :  |//       \\//       \\|  : :  ||____________________||  : :  |//       \\//  |R|  \\|  :
  :  |/         \/         \|  : :  ||---------||---------||  : :  |/         \/   |E|   \|  :
  :  || Sluice  || Sluice  ||  : :  ||         ||         ||  : :  ||         ||   |A|   ||  :
  :  ||   1     ||   2     ||  : :  ||         ||         ||  : :  ||         ||   |D|   ||  :
  :  ||         ||         ||  : :  ||         ||         ||  : :  ||         ||   | |   ||  :
  :  ||//     \\||//     \\||  : :  ||         ||         ||  : :  ||         ||// |2| \\||  :
  :  |//       \\//       \\|  : :  ||_________||_________||  : :  ||_________|//  |_|  \\|  :
  :  |/         \/         \|  : :  |----------------------|  : :  |-----------/         \|  :
  :                            : :      _          _   _      : :        _            _      :
  :  Status not locked         : :     / \        / \ / \     : :       / \          / \     :
  :                            : :     |T|        |T| |T|     : :       |T|          |T|     :
  :                            : :     |H|        |H| |H|     : :       |H|          |H|     :
  :                            : :     |R|        |R| |R|     : :       |R|          |R|     :
  :                            : :     |E|        |E| |E|     : :       |E|          |E|     :
  :                            : :     |A|        |A| |A|     : :       |A|          |A|     :
  :                            : :     |D|        |D| |D|     : :       |D|          |D|     :
  :                            : :     | |        | | | |     : :       | |          | |     :
  :                            : :     |1|        |2| |3|     : :       |1|          |3|     :
  :                            : :     |_|        |_| |_|     : :       |_|          |_|     :
  :............................: :............................: :............................:
  .............................. .............................. ..............................
  : D                          : : E                          : : F                 _        :
  :                            : :                            : :                  / \       :
  :                            : :                            : :                  |T|       :
  :                            : :                            : :                  |H|       :
  :                            : :                            : :                  |R|       :
  :                            : :                            : :                  |E|       :
  :                            : :                   _        : :                  |A|       :
  :                            : :                  / \       : :                  |D|       :
  :                            : :      //          |T|       : :                  | |       :
  :                            : :     //           |H| \     : :                  |2|       :
  :                            : :    //            |R| \\    : :                  |_|       :
  :   ______________________   : :   //             |E|  \\   : :   ______________________   :
  :  ||--------------------||  : :  |/              |A|   \|  : :  ||--------------------||  :
  :  ||               _    ||  : :  ||              |D|   ||  : :  ||                    ||  :
  :  ||              / \   ||  : :  ||              | |   ||  : :  ||                    ||  :
  :  ||              |T|   ||  : :  ||              |2|   ||  : :  ||                    ||  :
  :  ||              |H|   ||  : :  ||              |_|   ||  : :  ||                    ||  :
  :  ||//     \\  // |R| \\||  : :  ||//     \\  //     \\||  : :  ||                    ||  :
  :  |//       \\//  |E|  \\|  : :  |//       \\//       \\|  : :  ||_________  _________||  :
  :  |/         \/   |A|   \|  : :  |/         \/         \|  : :  ||---------||---------||  :
  :  ||         ||   |D|   ||  : :  ||         ||         ||  : :  ||         ||         ||  :
  :  ||         ||   | |   ||  : :  ||         ||         ||  : :  ||         ||         ||  :
  :  ||         ||   |2|   ||  : :  ||         ||         ||  : :  ||         ||         ||  :
  :  ||         ||   |_|   ||  : :  ||         ||         ||  : :  ||         ||         ||  :
  :  ||_________||_________||  : :  ||_________||_________||  : :  ||_________||_________||  :
  :  |----------------------|  : :  |----------------------|  : :  |----------------------|  :
  :       _             _      : :       _             _      : :      _              _      :
  :      / \           / \     : :      / \           / \     : :     / \            / \     :
  :      |T|           |T|     : :      |T|           |T|     : :     |T|            |T|     :
  :      |H|           |H|     : :      |H|           |H|     : :     |H|            |H|     :
  :      |R|           |R|     : :      |R|           |R|     : :     |R|            |R|     :
  :      |E|           |E|     : :      |E|           |E|     : :     |E|            |E|     :
  :      |A|           |A|     : :      |A|           |A|     : :     |A|            |A|     :
  :      |D|           |D|     : :      |D|           |D|     : :     |D|            |D|     :
  :      | |           | |     : :      | |           | |     : :     | |            | |     :
  :      |1|           |3|     : :      |1|           |3|     : :     |1|            |3|     :
  :      |_|           |_|     : :      |_|           |_|     : :     |_|            |_|     :
  :............................: :............................: :............................:
  .............................. .............................. ..............................
  : G                          : : H                          : : I                 _        :
  :                            : :                  _         : :                  / \       :
  :                 _          : :                 / \        : :                  |T|       :
  :                / \         : :                 |T|        : :                  |H|       :
  :                |T|         : :                 |H|        : :                  |R|       :
  :                |H|         : :                 |R|        : :                  |E|       :
  :                |R|         : :                 |E|        : :                  |A|       :
  :                |E|         : :                 |A|        : :                  |D|       :
  :                |A|         : :                 |D|        : :                  | |       :
  :                |D|         : :                 | |        : :                  |2|       :
  :                | |         : :                 |2|        : :        _         |_|       :
  :                |2|         : :                 |_|        : :       / \                  :
  :                |_|         : :                            : :       |T|          \\      :
  :                            : :                            : :     / |H|           \\     :
  :                            : :                            : :    // |R|            \\    :
  :   ______________________   : :   ______________________   : :   //  |E|             \\   :
  :  ||--------------------||  : :  ||--------------------||  : :  |/   |A|              \|  :
  :  ||                    ||  : :  ||    _               ||  : :  ||   |D|              ||  :
  :  ||    _               ||  : :  ||   / \              ||  : :  ||   | |              ||  :
  :  ||   / \              ||  : :  ||   |T|              ||  : :  ||   |1|              ||  :
  :  ||   |T|              ||  : :  ||   |H|              ||  : :  ||   |_|              ||  :
  :  ||// |H| \\           ||  : :  ||// |R| \\           ||  : :  ||//     \\  //     \\||  :
  :  |//  |R|  \\ _________||  : :  |//  |E|  \\ _________||  : :  |//       \\//       \\|  :
  :  |/   |E|   \|---------||  : :  |/   |A|   \|---------||  : :  |/         \/         \|  :
  :  ||   |A|   ||         ||  : :  ||   |D|   ||         ||  : :  ||         ||         ||  :
  :  ||   |D|   ||         ||  : :  ||   | |   ||         ||  : :  ||         ||         ||  :
  :  ||   | |   ||         ||  : :  ||   |1|   ||         ||  : :  ||         ||         ||  :
  :  ||// |1| \\||         ||  : :  ||   |_|   ||         ||  : :  ||         ||         ||  :
  :  |//  |_|  \\|_________||  : :  ||_________||_________||  : :  ||_________||_________||  :
  :  |/         \-----------|  : :  |----------------------|  : :  |----------------------|  :
  :                     _      : :                     _      : :                   _        :
  :                    / \     : :                    / \     : :                  / \       :
  :                    |T|     : :                    |T|     : :                  |T|       :
  :                    |H|     : :                    |H|     : :                  |H|       :
  :                    |R|     : :                    |R|     : :                  |R|       :
  :                    |E|     : :                    |E|     : :                  |E|       :
  :                    |A|     : :                    |A|     : :                  |A|       :
  :                    |D|     : :                    |D|     : :                  |D|       :
  :                    | |     : :                    | |     : :                  | |       :
  :                    |3|     : :                    |3|     : :                  |3|       :
  :                    |_|     : :                    |_|     : :                  |_|       :
  :............................: :............................: :............................:
  .............................. .............................. ..............................
  : J                 _        : : K                  _       : : L                   _      :
  :                  / \       : :                   / \      : :                    / \     :
  :                  |T|       : :                   |T|      : :       _            |T|     :
  :                  |H|       : :        _          |H|      : :      / \           |H|     :
  :        _         |R|       : :       / \         |R|      : :      |T|           |R|     :
  :       / \        |E|       : :       |T|         |E|      : :      |H|           |E|     :
  :       |T|        |A|       : :       |H|         |A|      : :      |R|           |A|     :
  :       |H|        |D|       : :       |R|         |D|      : :      |E|           |D|     :
  :       |R|        | |       : :       |E|         | |      : :      |A|           | |     :
  :       |E|        |2|       : :       |A|         |2|      : :      |D|           |2|     :
  :       |A|        |_|       : :       |D|         |_|      : :      | |           |_|     :
  :       |D|                  : :       | |                  : :      |1|                   :
  :       | |                  : :       |1|                  : :      |_|                   :
  :       |1|                  : :       |_|                  : :                            :
  :       |_|                  : :                            : :                            :
  :   ______________________   : :   ______________________   : :   ______________________   :
  :  ||--------------------||  : :  ||--------------------||  : :  ||--------------------||  :
  :  ||                    ||  : :  ||                    ||  : :  ||               _    ||  :
  :  ||                    ||  : :  ||               _    ||  : :  ||              / \   ||  :
  :  ||                    ||  : :  ||              / \   ||  : :  ||              |T|   ||  :
  :  ||                    ||  : :  ||              |T|   ||  : :  ||              |H|   ||  :
  :  ||                    ||  : :  ||//     \\  // |H| \\||  : :  ||//     \\  // |R| \\||  :
  :  ||_________  _________||  : :  |//       \\//  |R|  \\|  : :  |//       \\//  |E|  \\|  :
  :  ||---------||---------||  : :  |/         \/   |E|   \|  : :  |/         \/   |A|   \|  :
  :  ||         ||         ||  : :  ||         ||   |A|   ||  : :  ||         ||   |D|   ||  :
  :  ||         ||         ||  : :  ||         ||   |D|   ||  : :  ||         ||   | |   ||  :
  :  ||         ||         ||  : :  ||         ||   | |   ||  : :  ||         ||   |3|   ||  :
  :  ||         ||         ||  : :  ||         ||// |3| \\||  : :  ||         ||   |_|   ||  :
  :  ||_________||_________||  : :  ||_________|//  |_|  \\|  : :  ||_________||_________||  :
  :  |----------------------|  : :  |-----------/         \|  : :  |----------------------|  :
  :                   _        : :                            : :                            :
  :                  / \       : :                            : :                            :
  :                  |T|       : :                            : :                            :
  :                  |H|       : :                            : :                            :
  :                  |R|       : :                            : :                            :
  :                  |E|       : :                            : :                            :
  :                  |A|       : :                            : :                            :
  :                  |D|       : :                            : :                            :
  :                  | |       : :                            : :                            :
  :                  |3|       : :                            : :                            :
  :                  |_|       : :                            : :                            :
  :............................: :............................: :............................:
  .............................. ..............................
  : M     _              _     : : N      _             _     :
  :      / \            / \    : :       / \           / \    :
  :      |T|            |T|    : :       |T|           |T|    :
  :      |H|            |H|    : :       |H|           |H|    :
  :      |R|            |R|    : :       |R|        _  |R|    :
  :      |E|            |E|    : :       |E|       / \ |E|    :
  :      |A|            |A|    : :       |A|       |T| |A|    :
  :      |D|            |D|    : :       |D|       |H| |D|    :
  :      | |            | |    : :       | |       |R| | |    :
  :      |1|            |2|    : :       |1|       |E| |2|    :
  :      |_|          _ |_|    : :       |_|       |A| |_|    :
  :                  / \       : :                 |D|        :
  :      //          |T|       : :                 | |        :
  :     //           |H| \     : :                 |3|        :
  :    //            |R| \\    : :                 |_|        :
  :   //             |E|  \\   : :   ______________________   :
  :  |/              |A|   \|  : :  ||--------------------||  :
  :  ||              |D|   ||  : :  ||                    ||  :
  :  ||              | |   ||  : :  ||                    ||  :
  :  ||              |3|   ||  : :  ||                    ||  :
  :  ||              |_|   ||  : :  ||                    ||  :
  :  ||//     \\  //     \\||  : :  ||                    ||  :
  :  |//       \\//       \\|  : :  ||_________  _________||  :
  :  |/         \/         \|  : :  ||---------||---------||  :
  :  ||         ||         ||  : :  ||         ||         ||  :
  :  ||         ||         ||  : :  ||         ||         ||  :
  :  ||         ||         ||  : :  ||         ||         ||  :
  :  ||         ||         ||  : :  ||         ||         ||  :
  :  ||_________||_________||  : :  ||_________||_________||  :
  :  |----------------------|  : :  |----------------------|  :
  :                            : :                            :
  :                            : :                            :
  :............................: :............................:

  SluiceClusters interact with there depending SluiceJoined in the following
  monitor-synchronized way:
      _________________       _________________       __________________
  =  | Monitor         |     | Monitor         |     | Monitor          |
  =  | SluiceCluster   |     | Lock            |     | SluiceJoined     |
  =  |    _____________|_____|_      ________  |     |                  |
     |   | enter       |     | |...&gt;|isLocked| |     |                  |
  t  |   |             |     | |    |________| |     |      __________  |
  i  |   |             |     | |..........................&gt;| tryEnter | |
  m  |   |             |    _|_|..........................&gt;|          | |
  e  |   |             |   | |                 |  ___|_____|          | |
     |   |             |   | |    _______     _|_|  _|________________| |
  =  |   |             |   | |   |addLock|&lt;..| |   | |                  |
  =  |   |             |   |_|_  |_______|   |_|___| |                  |
  =  |   |             |     | |....................................... |
  =  |   |_____________|_ w _|_|..................................... : |
  =  |      ________   | |a| |                 |     |              : : |
  =  | ...&gt;| notify |  | |i| |                 |     |              : : |
  =  | :   |________|...&gt;|t| |                 |     |              : : |
  =  | :  _____________|_|e|_|_      ________  |     |              : : |
  =  | : |             |     | |...&gt;| addLock| |     |              : : |
  =  | : |_____________|_____|_|    |________| |     |              : : |
  V  |_:_______________|     |_________________|     |______________:_:_|
      _:_______________       _________________       ______________:_:_
  =  | : Monitor       |     | Monitor         |     | Monitor      : : |
  =  | : Res.Managed   |     | Lock            |     | Res.Depending: : |
  =  | :  _____________|_____|_                |     |     _____    : : |
     | : | leave       |     | |.........................&gt;|leave|&lt;..: : |
  t  | : |         ____|_____|_|.........................&gt;|     |&lt;....: |
  i  | : |        |    |     |                 |  ___|____|     |       |
  m  | : |        |    |  ___|__________      _|_|  _|__________|       |
  e  | : |        |   _|_|   |removeLock|&lt;...| |   | |                  |
     | : |        |  | |    _|__________|    |_|___| |                  |
  =  | :.............|_|___| |                 |     |                  |
  =  | : |        |____|_____|_      ________  |     |                  |
  =  | : |             |     | |...&gt;| unlock | |     |                  |
  =  | :.|_____________|_____|_|    |________| |     |                  |
  V  |_________________|     |_________________|     |__________________|

  */
  public static class SluiceCluster implements Semaphor{ // RessourceManaged

    private Lock lock;

    private SluiceJoined[] sluices;

    private final HashSet sluicesHash;

    public SluiceCluster(){
      this.lock = new Lock();
      this.sluicesHash = new HashSet();
    }

    public SluiceCluster(SluiceJoined[] managed){
      this.lock = new Lock();
      this.sluicesHash = new HashSet();
      if(managed != null){
        for(int i = 0; i &lt; managed.length; i++){
          this.addSluice(managed[i]);
        }
      }
    }

    public final boolean isLocked(){
      synchronized(this.lock){
        if(this.lock.count &gt; 0){
          return true;
        }
        else{
          return false;
        }
      }
    }

    public synchronized final boolean tryEnter(){
      if(this.isLocked()){
        return false;
      }
      else{
        this.addLock();
        SluiceJoined[] ressource = this.getSluicesJoined();
        if(MutualExclusion.tryEnter(ressource)){
          return true;
        }
        else{
          this.unlock();
          return false;
        }
      }
    }

    /*
     * @see org.conetex.thread.MutualExclusion.Semaphor#enter()
     */
    public synchronized final void enter(){
      // Siehe Kommentar zu Sluice.enter()!
      while(! this.tryEnter() ){
        try{
          this.wait();
        }
        catch(InterruptedException e){
          /** @todo behandle Exception */
        }
      }
    }

    public synchronized final void leave(){
      // Entferne Lock auf die verbundenen Sluice-Objecte
      this.leave(this.getSluicesJoined());
      // Entferne Lock auf dieses Sluice-Object
      this.unlock();
      // Siehe Kommentar zu Sluice.leave()!
      this.notify();
    }

    private void leave(SluiceJoined[] ressource){
      // Entferne Lock auf die verbundenen Sluice-Objecte
      if(ressource != null){
        for(int i = 0; i &lt; ressource.length; i++){
          ressource[i].leave();
        }
      }
    }

    private final void removeLock(){
      synchronized(this.lock){
        this.lock.count--;
      }
      if(this.lock.count == 0){
        synchronized(this){
          try{
            this.notify();
          }
          catch(Exception e){
            /** @todo behandle Exception */
          }
        }
      }
    }

    private final void addLock(){
      synchronized(this.lock){
        this.lock.count++;
      }
    }

    private final void unlock(){
      synchronized(this.lock){
        this.lock.count--;
      }
    }

    public synchronized final void addSluice(SluiceJoined managed){
      if(managed == null){
        return;
      }
      if(this.sluicesHash.contains(managed)){
        return;
      }
      // Setze Lock auf dieses Sluice-Object und die bisherigen Cluster-Member
      this.enter();
      // Speichere den Stand bisheriger Cluster-Member
      SluiceJoined[] ressource = this.getSluicesJoined();
      // neue Sluice hinzufügen
      this.sluicesHash.add(managed);
      managed.addManagingSluiceCluster(this);
      // Bereite nächstes Enter vor
      this.refreshSluices();
      // Entferne Locks der bisherigen Cluster-Member
      this.leave(ressource);
      // Entferne Lock auf dieses Sluice-Object
      this.unlock();
      // Siehe Kommentar zu Sluice.leave()!
      this.notify();
    }

    public synchronized final void removeSluice(SluiceJoined managed){
      if(managed == null){
        return;
      }
      if(!this.sluicesHash.contains(managed)){
        return;
      }
      // Setze Lock auf dieses Sluice-Object und die bisherigen Cluster-Member
      this.enter();
      // Speichere den Stand bisheriger Cluster-Member
      SluiceJoined[] ressource = this.getSluicesJoined();
      // Sluice entfernen
      this.sluicesHash.remove(managed);
      managed.removeManagingSluiceCluster(this);
      // Bereite nächstes Enter vor
      this.refreshSluices();
      // Entferne Locks der bisherigen Cluster-Member
      this.leave(ressource);
      // Entferne Lock auf dieses Sluice-Object
      this.unlock();
      // Siehe Kommentar zu Sluice.leave()!
      this.notify();
    }

    private final SluiceJoined[] getSluicesJoined(){
      return this.sluices;
    }

    public final SluiceJoined[] getSluices(){
      SluiceJoined[] source = this.getSluicesJoined();
      SluiceJoined[] target = new SluiceJoined[source.length];
      System.arraycopy(source, 0, target, 0, source.length);
      return target;
    }

    private final void refreshSluices(){
      Object[] objects = this.sluicesHash.toArray();
      this.sluices = new SluiceJoined[objects.length];
      for(int i = 0; i &lt; this.sluices.length; i++){
        this.sluices[i] = (SluiceJoined)objects[i];
      }
    }

    private static class Lock{

      private int count;

      private Lock(){
        this.count = 0;
      }

    }

  }

}
  </pre>
<!--
  <h1>
    <a name="Start" id="Start">
     Wenn HTML zu XHTML wird
    </a>
  </h1>
  <p>
   Dann müssen alle Elemente mit Inhalt ein End-Tag haben.
  </p>
  <p>
   Leere Elemente
  <br />
   müssen einen Schrägstrich am Ende haben.
  </p>
  <hr noshade="noshade" />
  <p>
   Leere Attribute erhalten ihren eigenen Namen als Wert zugewiesen.
  </p>
  <p>
   <a href="#Start">
    Verweise zu Ankern
   </a>
   springen zum Zielelement aufgrund des id-Attributs, nicht das name-Attributs.
  </p>
-->
 </body>
</html>